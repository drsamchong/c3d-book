
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Notebook exercise - working with spectral data (or patterns) &#8212; CHEM502 - Chemical Data, Discovery and Design</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=89ec2937" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '1-chem_data/spectrum_analysis';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Least squares optimisation" href="least_squares_opt.html" />
    <link rel="prev" title="Notebook exercise - molecular fingerprints" href="fingerprints.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/c3d_logo_white.png" class="logo__image only-light" alt="CHEM502 - Chemical Data, Discovery and Design - Home"/>
    <img src="../_static/c3d_logo_white.png" class="logo__image only-dark pst-js-only" alt="CHEM502 - Chemical Data, Discovery and Design - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Chemical Data, Discovery and Design
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Chemical data</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="descriptors-similarity.html">Molecular descriptors and similarity</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="fingerprints.html">Notebook exercise - molecular fingerprints</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="current reference internal" href="#">Notebook exercise - working with spectral data (or patterns)</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="least_squares_opt.html">Least squares optimisation</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../2-data_fundamentals/eda.html">Exploratory Data Analysis (EDA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2-data_fundamentals/eda_visualisation.html">Notebook - Visualisation in EDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workshop_files/eda_workshop.html">Workshop - Exploratory Data Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Intro to ML</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../3-ml_intro/ml_intro.html">Introduction to Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3-ml_intro/ML_demo.html">Notebook - ML for thermochemical data prediction</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/drsamchong/c3d-book/main?urlpath=lab/tree/book/1-chem_data/spectrum_analysis.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/drsamchong/c3d-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/drsamchong/c3d-book/issues/new?title=Issue%20on%20page%20%2F1-chem_data/spectrum_analysis.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/1-chem_data/spectrum_analysis.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Notebook exercise - working with spectral data (or patterns)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysing-spectra">Analysing spectra</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aim-of-this-notebook-exercise">Aim of this notebook exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#peak-processing-in-scipy">Peak processing in scipy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#peak-finding-getting-initial-model-parameters">Peak finding - getting initial model parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#peak-fitting-optimising-the-model-to-get-precise-peak-information">Peak fitting - optimising the model to get precise peak information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-fit">Assessing the fit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-metrics">Performance metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-points-summary"><strong>Key Points Summary:</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#things-to-try-and-or-consider">Things to try and/or consider:</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="notebook-exercise-working-with-spectral-data-or-patterns">
<h1>Notebook exercise - working with spectral data (or patterns)<a class="headerlink" href="#notebook-exercise-working-with-spectral-data-or-patterns" title="Link to this heading">#</a></h1>
<p>Experimental characterisation methods like NMR and IR commonly produce datasets in the form of 1-dimensional (or sometimes 2D) spectra. For simple 1D NMR experiments, for example, the spectrum is usually output in the form of intensity vs. chemical shift <span class="math notranslate nohighlight">\(\delta\)</span> in ppm.</p>
<section id="analysing-spectra">
<h2>Analysing spectra<a class="headerlink" href="#analysing-spectra" title="Link to this heading">#</a></h2>
<p>Determining information about the structure of molecules in the sample usually starts with extracting information about the peaks present in the NMR spectrum. The peak information can then be interpreted to provide specific information about the composition and connectivity of the molecule.</p>
<p>In general, fitting peaks with a function that models the shape serves several purposes including: to gain some fundamental understanding of the nature of the data (e.g. does the method and/or specific instrument produce a particular peak shape); if the peaks are modelled well, the information on their centres, amplitudes can be more precise.</p>
</section>
<section id="aim-of-this-notebook-exercise">
<h2>Aim of this notebook exercise<a class="headerlink" href="#aim-of-this-notebook-exercise" title="Link to this heading">#</a></h2>
<p>To get an overview how 1D spectral data can be analysed to acquire information about the peaks - positions of the centres, widths, intensities, etc. - we will look at a simple NMR spectrum and practise some pandas, matplotlib and scipy skills along the way.</p>
<p><em>Processing spectra involves modelling data.</em> This exercise also gives us a chance to look more closely at how a model is being applied to the data and see some of the considerations and issues you should be aware of as you work with even simple data problems.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To see the complete notebook, click <a class="reference internal" href="spectrum_analysis_full.html"><span class="std std-doc">here</span></a>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import statements</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_peaks</span><span class="p">,</span> <span class="n">peak_widths</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
</pre></div>
</div>
</div>
</div>
<p>The <sup>13</sup>C NMR spectrum of ethanol is stored as a csv file (<code class="docutils literal notranslate"><span class="pre">13C_EtOH.csv</span></code>) in the data directory <code class="docutils literal notranslate"><span class="pre">data</span></code>.</p>
<p>It is a good idea to check the contents of a file before you try to load it using Python.</p>
<p>This is particularly the case with data files to get an idea of the structure of the file, whether it has any header lines that you might want to skip over or if the column names are present, for example.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can run shell (terminal) command from a Jupyter notebook. More info here: <a class="reference external" href="https://tinyurl.com/2yv37k2x">https://tinyurl.com/2yv37k2x</a></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the `head` shell command to look at the first few lines of the file </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read the NMR spectrum from the csv into a pandas dataframe called nmr_spec</span>

<span class="c1"># nmr_spec = ...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment line below and run cell to complete code to load the csv file</span>
<span class="c1"># %load ../code_snips/load_nmr_csv.txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the spectrum</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nmr_spec</span><span class="p">[</span><span class="s2">&quot;ppm&quot;</span><span class="p">],</span> <span class="n">nmr_spec</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Chemical shift $</span><span class="se">\\</span><span class="s2">delta$ / ppm&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathregular{^</span><span class="si">{13}</span><span class="s2">C}$ NMR spectrum of ethanol&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Plot the spectrum</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nmr_spec</span><span class="p">[</span><span class="s2">&quot;ppm&quot;</span><span class="p">],</span> <span class="n">nmr_spec</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Chemical shift $</span><span class="se">\\</span><span class="s2">delta$ / ppm&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity&quot;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;nmr_spec&#39; is not defined
</pre></div>
</div>
<img alt="../_images/8852035462ddaea257dd94f8f88f277b0993cb5e85d77d5a256d5d65b3ca98dc.png" src="../_images/8852035462ddaea257dd94f8f88f277b0993cb5e85d77d5a256d5d65b3ca98dc.png" />
</div>
</div>
<p>The code above uses matplotlib’s <code class="docutils literal notranslate"><span class="pre">pyplot.plot</span></code> to graph the spectrum. This might be how you have mostly seen plotting in matplotlib so far.</p>
<p>Pandas also provides a <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.plot.html"><code class="docutils literal notranslate"><span class="pre">plot</span></code> method</a> on its DataFrame and Series objects that offers a convenient way to <a class="reference external" href="https://pandas.pydata.org/docs/user_guide/visualization.html">visualise data</a> using matplotlib (it uses matplotlib by default but can be changed to others, e.g. plotly).</p>
<p>For example, it will pick up axis labels from the DataFrame columns, but you can also modify if preferred.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Try it yourself:</span>
<span class="c1"># Plot an equivalent graph of the NMR spectrum using DataFrame.plot()</span>

<span class="c1"># Your code here...</span>



<span class="c1"># Uncomment the line below and run the cell to see some code that works</span>
<span class="c1"># %load ../code_snips/df_plot.txt</span>
</pre></div>
</div>
</div>
</div>
<p>Decomposing the spectrum into a set of peaks can sometimes be incorporated into the processing that is done by the experimental acquisition software. There are also various Python packages dedicated to different types of spectroscopic data which can facilitate integration into automated data processing pipelines.</p>
<p>To get a picture of what is going in this process, we can use some of the general methods available in scipy’s signal processing and optimisation subpackages to analyse the peaks in our simple NMR spectrum.</p>
</br></section>
<section id="peak-processing-in-scipy">
<h2>Peak processing in scipy<a class="headerlink" href="#peak-processing-in-scipy" title="Link to this heading">#</a></h2>
<p>In CHEM501, you used some of the functions available in <a class="reference external" href="https://docs.scipy.org/doc/scipy/index.html">SciPy</a>’s <a class="reference external" href="https://docs.scipy.org/doc/scipy/tutorial/optimize.html#optimization-scipy-optimize"><code class="docutils literal notranslate"><span class="pre">optimize</span></code></a> subpackage that can be used to fit population distributions by modelling the population distribution function (PDF) as a curve that follows a Gaussian (or Lorentzian) function.</p>
<p>We can use the same process to fit peaks in experimentally measured datasets like NMR spectra.</p>
<p>The peaks in NMR spectra are usually described as Lorentzian functions, but sometimes Gaussian or pseudo-Voigt (a mixture of Gaussian and Lorentzian) shapes are used. For our <sup>13</sup>C NMR spectrum, we can define the Lorentzian and Gaussian functions:</p>
<p><a class="reference external" href="https://mathworld.wolfram.com/LorentzianFunction.html"><strong>Lorentzian</strong></a></p>
<div class="math notranslate nohighlight">
\[y = \frac{A}{\pi} \frac{W/2}{(x-x_0)^2+(W/2)^2}\]</div>
<p>where <em>A</em> is the amplitude of the peak, <em>W</em> is the full width at half maximum (FWHM) and <em>x</em><sub>0</sub> is value of <em>x</em> at the peak centre.</p>
</br>
<p><a class="reference external" href="https://mathworld.wolfram.com/GaussianFunction.html"><strong>Gaussian</strong></a></p>
<div class="math notranslate nohighlight">
\[y = A \cdot \frac{1}{\sigma\sqrt{2\pi}}\;\exp(-\frac{(x-x_0)^2}{2\sigma^2})\]</div>
<!---$$y = f(x) = A \cdot \frac{1}{\sigma\sqrt{2\pi}}\;e^{-\frac{(x-x_0)^2}{2\sigma^2}}$$--->
<p>Here, <em>x</em><sub>0</sub> rather than <span class="math notranslate nohighlight">\(\mu\)</span> is used to represent the centre of the peak (for the normal PDF, <span class="math notranslate nohighlight">\(\mu\)</span> was the mean of the  distribution) and <span class="math notranslate nohighlight">\(\sigma\)</span> and the FWHM, <em>W</em>, of the peak are related by:
$<span class="math notranslate nohighlight">\(
W = \sigma\sqrt{8\:\ln2}
\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These functions will calculate a peak using a Gaussian or Lorentzian function as defined above.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gaussian</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">ampl</span><span class="p">,</span> <span class="n">centre</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a signal with a Gaussian shape.&quot;&quot;&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ampl</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x_array</span><span class="o">-</span><span class="n">centre</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">lorentzian</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">ampl</span><span class="p">,</span> <span class="n">centre</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a signal with a Lorentzian shape.&quot;&quot;&quot;</span>
    <span class="n">h_width</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">ampl</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">h_width</span><span class="o">/</span><span class="p">((</span><span class="n">x_array</span><span class="o">-</span><span class="n">centre</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">h_width</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Before using the functions to try fitting the NMR peaks, we can look at an example of what the two peak shapes look like by simulating a peak generated by the two functions and plotting them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write some code here to generate a peak of each type centred at 1, with a width of 0.1 and amplitude of 10.</span>
<span class="c1"># Tip: the numpy linspace method makes it straightforward to generate an equally-spaced array of numbers for the</span>
<span class="c1"># x-axis data.</span>

<span class="c1"># Your code here...</span>


<span class="c1"># Once you have the two peaks, plot them on the same set of axes to compare them.</span>

<span class="c1"># Your code here...</span>

<span class="c1"># Uncomment the line below and run the cell to see some code that works</span>
<span class="c1"># %load ../code_snips/gen_peaks.txt</span>
</pre></div>
</div>
</div>
</div>
<p>We now know that the functions can model the shape of Lorentzian and Gaussian peaks. So we should be able to use them to try to fit the peaks in the NMR spectrum. The fitting process optimises the model’s parameters to obtain a calculated spectrum that is as close as possible to the experimentally observed data.</p>
<p>Both the Lorentzian and Gaussian models have three parameters that can be varied to modify the peak shape: the amplitude, position of the peak’s centre and the peak’s width. Depending on the type of measurement, all three can provide information about the analyte.</p>
<p>We will use <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.curve_fit.html"><code class="docutils literal notranslate"><span class="pre">scipy.optimize.curve_fit</span></code></a> to fit the peaks in the spectrum. It uses <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.least_squares.html#scipy.optimize.least_squares">non-linear least squares</a> to fit a function - in this case the Lorentzian we defined - to a set of data.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Here is a basic intro to <a class="reference internal" href="least_squares_opt.html"><span class="doc std std-doc">Least Squares Optimisation</span></a>.</p>
</div>
</br><section id="peak-finding-getting-initial-model-parameters">
<h3>Peak finding - getting initial model parameters<a class="headerlink" href="#peak-finding-getting-initial-model-parameters" title="Link to this heading">#</a></h3>
<p>You might remember that the optimisation needs a set of initial guesses for the parameters to fit the curve. For one or two peaks, that is easily done by hand, but we can use scipy’s signal processing <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.find_peaks.html"><code class="docutils literal notranslate"><span class="pre">scipy.signal.find_peaks</span></code></a> to do this in Python.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code> function locates local maxima in the 1D array it is passed by comparing data points with neighbouring values.</p>
<p>Try running the function on the intensity data of the NMR spectrum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pass the NMR intensities to the find_peaks function and check the results (take a look at the `find_peaks` docs to see what it returns). </span>
<span class="c1"># Note the shape of the array storing the indices of the peaks in the intensity array.</span>

<span class="n">peak_idx</span><span class="p">,</span> <span class="n">peak_info</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">nmr_spec</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>
<span class="n">peak_idx</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">array([</span>&#160;&#160; <span class="pre">1,</span>&#160;&#160;&#160; <span class="pre">3,</span>&#160;&#160;&#160; <span class="pre">5,</span> <span class="pre">...,</span> <span class="pre">6989,</span> <span class="pre">6994,</span> <span class="pre">6998],</span> <span class="pre">shape=(2320,))</span></code></p>
<p>Running the peak finding on the intensities without providing any extra constraints results in <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code> locating over 2000 peaks in the spectrum, rather than the two we see when we plot the spectrum. The additional “peaks” are weak intensity local maxima. The vast majority (all but two) are points that are higher intensity than their surroundings, but not significantly higher than the backgground noise.</p>
<p><code class="docutils literal notranslate"><span class="pre">find_peaks</span></code> can also take other arguments that filter the peaks it finds based on the properties of the peaks. The information it returns will also depend on the arguments passed.
Check the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.find_peaks.html">docs</a> and modify the call to <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code> to filter the peaks and get the information required as initial guesses for the Lorentzian peaks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modify the call to `find_peaks` below to filter the peaks to just the two real resonances.</span>
<span class="c1"># Your call should include parameters so that the function returns enough peak information to get initial values for </span>
<span class="c1"># peak amplitude, centre and width.</span>

<span class="n">peak_idx</span><span class="p">,</span> <span class="n">peak_info</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">nmr_spec</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>

<span class="c1"># uncomment the line below and run the cell to load the complete code</span>
<span class="c1"># %load ../code_snips/find_peaks_filter.txt</span>

<span class="c1"># Your code here...</span>


<span class="nb">print</span><span class="p">(</span><span class="n">peak_idx</span><span class="p">)</span>
<span class="n">peak_info</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">find_peaks</span></code> is not aware of the data along the x-axis, i.e. the chemical shift, there is still some work to pull out the peak centres and the width of the peaks in ppm - at the moment, the widths are given in terms of the number of data points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the indices of the peaks to work out the peak centres in ppm and add them to the peak_info dictionary with the key &quot;centres&quot;.</span>

<span class="c1"># Your code here...</span>


<span class="c1"># uncomment the line below and run the cell to load some code to do this</span>
<span class="c1"># %load ../code_snips/peak_centres_ppm.txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The widths are currently expressed in terms of number of data points, i.e. &quot; &#39;widths&#39;: array([2.7734915 , 3.57548198]) &quot; </span>
<span class="c1"># means the FWHM of the first peak is the distance between 2.77 points, which assumes they are evenly spaced.</span>
<span class="c1"># Work out the widths in ppm. Update the widths in the peak_info dictionary to these values.</span>
<span class="c1"># Hint: You can calculate the distance between adjacent rows in a pandas Series using the diff() method.</span>


<span class="c1"># Your code here...</span>


<span class="c1"># uncomment the line below and run the cell to load some code to do this</span>
<span class="c1"># %load ../code_snips/widths_ppm.txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the peak information</span>
<span class="n">peak_info</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tidy up the peak information</span>

<span class="n">peak_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">peak_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;peak_heights&quot;</span><span class="p">,</span> <span class="s2">&quot;widths&quot;</span><span class="p">,</span> <span class="s2">&quot;centres&quot;</span><span class="p">]}</span>
</pre></div>
</div>
</div>
</div>
<p>OK! Finally, let’s try fitting the Lorentzian model to the NMR peaks.</p>
</br></section>
<section id="peak-fitting-optimising-the-model-to-get-precise-peak-information">
<h3>Peak fitting - optimising the model to get precise peak information<a class="headerlink" href="#peak-fitting-optimising-the-model-to-get-precise-peak-information" title="Link to this heading">#</a></h3>
<p>Now you are ready to run the least squares optimisation to fit the curves to the peaks in the spectrum.</p>
<p>For this simple spectrum, the peaks are well separated so can be fitted separately and the baseline is very low and flat. Check the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.curve_fit.html"><code class="docutils literal notranslate"><span class="pre">curve_fit</span></code> docs</a> if you need a reminder of how to call the function, passing in the information from the peak_info dictionary as the initial values for the parameters.</p>
<p>One thing to note: The amplitude of the fitted curve will be the integrated intensity - the area under the peak. You can estimate the initial area as that of a rectangle of <em>height = peak height</em> and <em>width = peak width</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run `curve_fit` for each of the peaks in the NMR spectrum and store the output in the lists popt_list and pcov_list</span>

<span class="n">popt_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pcov_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Your code here...</span>




<span class="c1"># uncomment the line below and run the cell to load some code to do this</span>
<span class="c1"># %load ../code_snips/run_curve_fits.txt</span>


<span class="n">display</span><span class="p">(</span><span class="n">popt_list</span><span class="p">,</span> <span class="n">pcov_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assessing-the-fit">
<h3>Assessing the fit<a class="headerlink" href="#assessing-the-fit" title="Link to this heading">#</a></h3>
<p>Check the optimised parameters of the fitted Lorentzian peaks stored in <code class="docutils literal notranslate"><span class="pre">popt_list</span></code>. These will be <code class="docutils literal notranslate"><span class="pre">[amplitude,</span> <span class="pre">centre,</span> <span class="pre">width]</span></code> for each peak.</p>
<p>Take another look at the spectrum. Do these values look reasonable? It might be difficult to tell with the areas, but
remember the rectangular approximation.</p>
<p>The covariance matrix for the fitted functions are in <code class="docutils literal notranslate"><span class="pre">pcov_list</span></code>. The diagonal elements are the variances of the parameters and these can be used to estimate the errors (uncertainties) on the parameters (see <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.curve_fit.html">docs</a> for info).</p>
</br><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the 1-standard deviation errors for each of the parameters of the peaks. </span>
<span class="c1"># Report the parameter values and the associated errors.</span>


<span class="k">def</span><span class="w"> </span><span class="nf">report_peak_fit</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">perr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print peak function parameters and 1-sigma errors&quot;&quot;&quot;</span>
    <span class="n">report</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude: </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">perr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> 
              <span class="sa">f</span><span class="s2">&quot;Centre: </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Width: </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

<span class="c1"># Write a comment to explain what this code is doing.</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span> <span class="k">for</span> <span class="n">pcov</span> <span class="ow">in</span> <span class="n">pcov_list</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">popt_list</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">report_peak_fit</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We can also overlay a spectrum calculated from the optimised peak parameters to see if the fitted peaks look reasonable by eye.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function simulates a spectrum using the specified peak shape function and a set of parameters passed as a dictionary.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">simulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">simulate_spectrum</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">collate_fitted_peak_parameters</span><span class="p">(</span><span class="n">popt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Make a dictionary of peak parameters &quot;&quot;&quot;</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ampl&quot;</span><span class="p">,</span> <span class="s2">&quot;centre&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">popt</span><span class="p">))</span>

<span class="n">fitted_peaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">collate_fitted_peak_parameters</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span> <span class="k">for</span> <span class="n">popt</span> <span class="ow">in</span> <span class="n">popt_list</span><span class="p">]</span> <span class="c1"># assemble a list of dictionaries for peak parameters</span>

<span class="n">lor_spec_x</span><span class="p">,</span> <span class="n">lor_spec_y</span> <span class="o">=</span> <span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">lorentzian</span><span class="p">,</span> <span class="n">nmr_spec</span><span class="p">[</span><span class="s2">&quot;ppm&quot;</span><span class="p">],</span> <span class="n">fitted_peaks</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># y_sigma = nmr_spec[&quot;intensity&quot;].std()</span>
<span class="c1"># y_errors = [y_sigma for y in nmr_spec[&quot;intensity&quot;]]</span>

<span class="n">nmr_spec</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">,</span> 
              <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
              <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Chemical shift $</span><span class="se">\\</span><span class="s2">delta$ / ppm&quot;</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span>
              <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
              <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Measured&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lor_spec_x</span><span class="p">,</span> <span class="n">lor_spec_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Calculated&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathregular{^</span><span class="si">{13}</span><span class="s2">C}$ NMR spectrum of ethanol&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Does this look like a good fit? Try changing the x-limits to check the fit of the peaks more closely.</p>
</br></section>
<section id="performance-metrics">
<h3>Performance metrics<a class="headerlink" href="#performance-metrics" title="Link to this heading">#</a></h3>
<p>We can also use a variety of metrics to assess how well the modelled spectrum fits the experimental data.</p>
<p><span class="math notranslate nohighlight">\(R\)</span><sup>2</sup> (coefficient of determination) is a statistical measure of how well the model explains the variability of the dependent variable (here, the intensity). Its form is quite intuitive and it is defined as follows:</p>
<div class="math notranslate nohighlight">
\[R^2 = 1 - \frac{SSR}{SST}\]</div>
<p>where:</p>
<ul>
<li><p><strong>SSR (Sum of Squared Residuals)</strong>: also called the residual sum of squares (<strong>RSS</strong>), is the quantity minimised by least square. It measures the total squared differences between the observed values and the predicted values from the model.</p>
<div class="math notranslate nohighlight">
\[SSR = \sum (y_i - \hat{y}_i)^2\]</div>
</li>
<li><p><strong>SST (Total Sum of Squares)</strong>: measures the total variability in the observed data (without any model), based on the mean <span class="math notranslate nohighlight">\(\bar{y}\)</span>:</p>
<div class="math notranslate nohighlight">
\[SST = \sum (y_i - \bar{y})^2\]</div>
</li>
<li><p>If the model fits perfectly, <span class="math notranslate nohighlight">\( SSR = 0 \)</span> and <span class="math notranslate nohighlight">\( R^2 = 1 \)</span>, meaning all variability in the data is explained by the model.</p></li>
<li><p>If the model is no better than simply using the mean <span class="math notranslate nohighlight">\( \bar{y} \)</span>, then <span class="math notranslate nohighlight">\( SSR = SST \)</span> and <span class="math notranslate nohighlight">\( R^2 = 0 \)</span>.</p></li>
<li><p>If the model is worse than using the mean (e.g., a bad fit), <span class="math notranslate nohighlight">\( R^2 \)</span> can be negative.</p></li>
</ul>
<p>In least squares fitting, reducing SSR improves the model fit and increases <span class="math notranslate nohighlight">\( R^2 \)</span>, so a good fit has a high <span class="math notranslate nohighlight">\( R^2 \)</span> close to 1.</p>
<p>We could calculate <span class="math notranslate nohighlight">\(R\)</span><sup>2</sup> manually (code in cell below), but scikit-learn’s <a class="reference external" href="https://scikit-learn.org/stable/api/sklearn.metrics.html"><code class="docutils literal notranslate"><span class="pre">metrics</span></code> package</a> makes it straightforward to calculate many measures of model performance.</p>
</br>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To calculate r^2:</span>

<span class="c1"># residuals = lor_spec_y - nmr_spec[&quot;intensity&quot;]</span>
<span class="c1"># squared_residuals = residuals ** 2</span>
<span class="c1"># SSR = squared_residuals.sum()</span>
<span class="c1"># SST = ((nmr_spec[&quot;intensity&quot;] - nmr_spec[&quot;intensity&quot;].mean())**2).sum()</span>
<span class="c1"># r2 = 1-(SSR/SST)</span>
<span class="c1"># print(r2)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the relevant function from sklearn.metrics to calculate r^2, the coefficient of determination</span>


<span class="c1"># uncomment the line below and run the cell to load some code to do this</span>
<span class="c1"># %load ../code_snips/r2_sklearn.txt</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="key-points-summary">
<h2><strong>Key Points Summary:</strong><a class="headerlink" href="#key-points-summary" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Real-World Data Modeling</strong>: In many areas of chemistry (e.g., NMR, IR spectroscopy), fitting models to experimental data is crucial for extracting meaningful information, such as peak positions and intensities.</p></li>
<li><p><strong>Peak Fitting</strong>: Fitting peaks with a model function helps extract more precise information about the data (e.g., determining peak centers, amplitudes, and widths) compared to raw data points.</p></li>
<li><p><strong>Use of Least Squares</strong>: Least squares optimisation plays a central role in fitting models to experimental data. It helps minimise the difference between the model predictions and the observed data, providing the best-fit parameters for the model.</p></li>
<li><p><strong>Practical Considerations</strong>: When fitting models, especially in noisy or complex data, it is important to consider the quality of the fit and how well the model reflects the underlying data. This exercise highlights common issues in fitting, such as choosing an appropriate model and evaluating the fit.</p></li>
<li><p><strong>Iterative Process</strong>: Fitting is often an iterative process. You may need to try different initial guesses for the model parameters, refine the model, and evaluate how well the fit matches the data.</p></li>
</ul>
</section>
<section id="things-to-try-and-or-consider">
<h2>Things to try and/or consider:<a class="headerlink" href="#things-to-try-and-or-consider" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Write some code to add a line that shows the residuals as a difference plot below the final graph of the experimental and calculated data.</p></li>
<li><p>Repeat the fit using the Gaussian function. Is this a better or worse model for the NMR peak shapes?</p></li>
<li><p>What happens if the initial guesses for the peak function’s parameters are not close to the actual values? Try fitting the peaks with one of the centres far from the real location. What happens?</p></li>
<li><p>We treated the spectrum using a very generic peak fitting process. Specialised NMR analysis libraries have methods to deal with more complex data much more efficiently (but many will still be using least squares underneath). Can you think of what additional complexities <sup>1</sup>H NMR might pose, for example? What issues might arise if peaks are much closer together?</p></li>
<li><p>The 7000 points of the NMR data have effectively been reduced to six numbers. This poses some questions about how data is stored, reported and used for further analysis. What factors might be important when making those decisions? Are there any disadvantages of only having the peak information available? Would the choice be different (how, why) in different scenarios?</p></li>
<li><p>You can see how it might be possible to automate this process for NMR spectra and other types of measured datasets. What steps would be needed now to interpret the information to translate it to knowledge about the molecule? How straightforward is this to automate?</p></li>
</ul>
</section>
<div class="toctree-wrapper compound">
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "drsamchong/c3d-book",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./1-chem_data"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="fingerprints.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Notebook exercise - molecular fingerprints</p>
      </div>
    </a>
    <a class="right-next"
       href="least_squares_opt.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Least squares optimisation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysing-spectra">Analysing spectra</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aim-of-this-notebook-exercise">Aim of this notebook exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#peak-processing-in-scipy">Peak processing in scipy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#peak-finding-getting-initial-model-parameters">Peak finding - getting initial model parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#peak-fitting-optimising-the-model-to-get-precise-peak-information">Peak fitting - optimising the model to get precise peak information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-fit">Assessing the fit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-metrics">Performance metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-points-summary"><strong>Key Points Summary:</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#things-to-try-and-or-consider">Things to try and/or consider:</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sam Chong
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>